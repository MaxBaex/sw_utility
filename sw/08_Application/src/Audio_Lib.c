/**
  * ############################################################################
  * @file     Audio_Lib.c
  * @brief    New Vario
  * @author   Horst Rupp
  * @brief    This task
  * ############################################################################
  */
//
// Includes
//
#include  "Generic_Common.h"
#include  "Generic_Includes.h"

#include  "task_Audio_Controller.h"

extern  DAC_HandleTypeDef hdac1;
extern  DMA_HandleTypeDef hdma_dac1;
extern  TIM_HandleTypeDef htim6;

#define c_Wave_Size  128

//
//  sinus + 16te harmonic  (HMR 27.4.21)
//
#if 1		// Sinus mit 16. harmonischer Oberwelle 30%
float Wave_Raw[c_Wave_Size] = {
		0.000000,
		258.162537,
		488.604238,
		667.796613,
		779.957677,
		819.426918,
		791.499558,
		711.593170,
		602.873592,
		492.701639,
		408.441624,
		373.269873,
		402.621413,
		501.815839,
		665.223877,
		877.101568,
		1113.965145,
		1348.145081,
		1551.978319,
		1702.000469,
		1782.499820,
		1787.892137,
		1723.554735,
		1604.992902,
		1455.465602,
		1302.431957,
		1173.359539,
		1091.532632,
		1072.498657,
		1121.693775,
		1233.609165,
		1392.624918,
		1575.384615,
		1754.349073,
		1901.988251,
		1994.973136,
		2017.729426,
		1964.811993,
		1841.738626,
		1664.156113,
		1455.465602,
		1243.268747,
		1055.175648,
		914.612776,
		837.269051,
		828.721107,
		883.599232,
		986.420926,
		1113.965145,
		1238.825723,
		1333.602963,
		1375.095200,
		1347.852182,
		1246.549235,
		1076.820710,
		854.425794,
		602.873592,
		349.869015,
		123.120471,
		-53.852443,
		-165.273093,
		-205.482749,
		-179.774848,
		-103.561618,
		0.000000,
		103.561618,
		179.774848,
		205.482749,
		165.273093,
		53.852443,
		-123.120471,
		-349.869015,
		-602.873592,
		-854.425794,
		-1076.820710,
		-1246.549235,
		-1347.852182,
		-1375.095200,
		-1333.602963,
		-1238.825723,
		-1113.965145,
		-986.420926,
		-883.599232,
		-828.721107,
		-837.269051,
		-914.612776,
		-1055.175648,
		-1243.268747,
		-1455.465602,
		-1664.156113,
		-1841.738626,
		-1964.811993,
		-2017.729426,
		-1994.973136,
		-1901.988251,
		-1754.349073,
		-1575.384615,
		-1392.624918,
		-1233.609165,
		-1121.693775,
		-1072.498657,
		-1091.532632,
		-1173.359539,
		-1302.431957,
		-1455.465602,
		-1604.992902,
		-1723.554735,
		-1787.892137,
		-1782.499820,
		-1702.000469,
		-1551.978319,
		-1348.145081,
		-1113.965145,
		-877.101568,
		-665.223877,
		-501.815839,
		-402.621413,
		-373.269873,
		-408.441624,
		-492.701639,
		-602.873592,
		-711.593170,
		-791.499558,
		-819.426918,
		-779.957677,
		-667.796613,
		-488.604238,
		-258.162537
  };
#endif
// *********************
#if 0			// reiner Sinuston
float Wave_Raw[c_Wave_Size] = {
	0.000000,
	100.490597,
	200.739103,
	300.504012,
	399.544979,
	497.623408,
	594.503019,
	689.950420,
	783.735669,
	875.632831,
	965.420517,
	1052.882420,
	1137.807837,
	1219.992176,
	1299.237446,
	1375.352740,
	1448.154688,
	1517.467905,
	1583.125408,
	1644.969024,
	1702.849766,
	1756.628193,
	1806.174749,
	1851.370072,
	1892.105283,
	1928.282245,
	1959.813808,
	1986.624007,
	2008.648254,
	2025.833492,
	2038.138320,
	2045.533094,
	2048.000000,
	2045.533094,
	2038.138320,
	2025.833492,
	2008.648254,
	1986.624007,
	1959.813808,
	1928.282245,
	1892.105283,
	1851.370072,
	1806.174749,
	1756.628193,
	1702.849766,
	1644.969024,
	1583.125408,
	1517.467905,
	1448.154688,
	1375.352740,
	1299.237446,
	1219.992176,
	1137.807837,
	1052.882420,
	965.420517,
	875.632831,
	783.735669,
	689.950420,
	594.503019,
	497.623408,
	399.544979,
	300.504012,
	200.739103,
	100.490597,
	0.000000,
	-100.490597,
	-200.739103,
	-300.504012,
	-399.544979,
	-497.623408,
	-594.503019,
	-689.950420,
	-783.735669,
	-875.632831,
	-965.420517,
	-1052.882420,
	-1137.807837,
	-1219.992176,
	-1299.237446,
	-1375.352740,
	-1448.154688,
	-1517.467905,
	-1583.125408,
	-1644.969024,
	-1702.849766,
	-1756.628193,
	-1806.174749,
	-1851.370072,
	-1892.105283,
	-1928.282245,
	-1959.813808,
	-1986.624007,
	-2008.648254,
	-2025.833492,
	-2038.138320,
	-2045.533094,
	-2048.000000,
	-2045.533094,
	-2038.138320,
	-2025.833492,
	-2008.648254,
	-1986.624007,
	-1959.813808,
	-1928.282245,
	-1892.105283,
	-1851.370072,
	-1806.174749,
	-1756.628193,
	-1702.849766,
	-1644.969024,
	-1583.125408,
	-1517.467905,
	-1448.154688,
	-1375.352740,
	-1299.237446,
	-1219.992176,
	-1137.807837,
	-1052.882420,
	-965.420517,
	-875.632831,
	-783.735669,
	-689.950420,
	-594.503019,
	-497.623408,
	-399.544979,
	-300.504012,
	-200.739103,
	-100.490597
  };
#endif
// *********************



uint32_t  Wave[c_Wave_Size] = { 0 };
uint8_t   m_up, m_half;
uint16_t  m_Prev_Frequency, m_Prev1_Volume, m_Prev2_Volume;
//extern uint16_t  g_Next_Frequency, g_Next_Volume;

#define c_change_first_half    0
#define c_change_second_half   1

//
// *****************************************************************************
//
void Set_Volume ( uint16_t vol )
{
  uint8_t l_ix, l_first_ix, l_last_ix;
  int16_t  iyy;
  float     ixx;

  if ( vol > 1000 )     // representing 100.0% Volume
    vol = 1000;

  //
  //  Organize according to IRs at
  //  HAL_DAC_Conv_HALF_CpltCallbackCh1
  //  and
  //  HAL_DAC_Conv_**_CpltCallbackCh1
  //  to change volume on the fly
  //
  if ( m_half == 0 )
  {
    l_first_ix  = 0;
    l_last_ix   = c_Wave_Size/2;
  }
  else
  {
    l_first_ix  = c_Wave_Size/2;
    l_last_ix   = c_Wave_Size;
  }

  //
  //  Move the appropriate half of data into hot area
  //
  for ( l_ix = l_first_ix; l_ix < l_last_ix; l_ix++ )
  {
    ixx = Wave_Raw[l_ix] * 0.001 * (float) ( vol * 10 );
    iyy = round ( ixx );
    Wave[l_ix] = 2048 + iyy;
  }
}

//
// *****************************************************************************
//
void Set_Frequency ( uint16_t freq )
{
  uint16_t l_retcode;
  uint16_t  l_period = 168000000 / freq / c_Wave_Size;
  htim6.Init.Period = l_period;
  l_retcode = HAL_TIM_Base_Init(&htim6);
  ASSERT (l_retcode == HAL_OK);
}

// =============================================================================
//

void Start_Audio (uint16_t vol, uint16_t freq )
{
  HAL_StatusTypeDef   l_HAL_retcode;
  m_half  = 0;
  Set_Volume ( vol );     // Start-Lautstaerke
  m_half  = 1;
  Set_Volume ( vol );
  m_half  = 1;            // Start-Frequenz
  Set_Frequency ( freq );
  l_HAL_retcode = HAL_DAC_Start_DMA   ( &hdac1,
                                        DAC_CHANNEL_1,
                                        (uint32_t*)Wave,
                                        c_Wave_Size,
                                        DAC_ALIGN_12B_R
                                      );
  ASSERT ( l_HAL_retcode == HAL_OK );
  HAL_TIM_Base_Start  ( &htim6 );
  ASSERT ( l_HAL_retcode == HAL_OK );
}

//
// *****************************************************************************
//
void HAL_DAC_ConvHalfCpltCallbackCh1(DAC_HandleTypeDef *hdac1)
{
  m_half = 0;
  if  ( m_Prev1_Volume != g_Next_Volume )
  {
    m_Prev1_Volume = g_Next_Volume;
    Set_Volume ( g_Next_Volume );
  }

  if  ( m_Prev_Frequency != g_Next_Frequency )
  {
    m_Prev_Frequency = g_Next_Frequency;
    Set_Frequency ( g_Next_Frequency );
  }
}

//
// *****************************************************************************
//
void HAL_DAC_ConvCpltCallbackCh1(DAC_HandleTypeDef *hdac)
{
  m_half = 1;
  if  ( m_Prev2_Volume != g_Next_Volume )
  {
    m_Prev2_Volume = g_Next_Volume;
    Set_Volume ( g_Next_Volume );
  }
  if  ( m_Prev_Frequency != g_Next_Frequency )
  {
    m_Prev_Frequency = g_Next_Frequency;
    Set_Frequency ( g_Next_Frequency );
  }
}

//
// *******************************************************************************
// The End
// *******************************************************************************
